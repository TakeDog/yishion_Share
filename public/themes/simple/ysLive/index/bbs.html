<layout name="public@layout_live" />
<!-- <link rel="stylesheet" href="__STATIC__/css/ueditor.css"> -->
<script src="__STATIC__/lib/ueditor_php/utf8-php/ueditor.config.js"></script>
<script src="__STATIC__/lib/ueditor_php/utf8-php/ueditor.all.js"></script>
<script type="text/javascript" charset="utf-8" src="__STATIC__/lib/ueditor_php/utf8-php/lang/zh-cn/zh-cn.js"></script>

<style>
    .no-padding-card .el-card__body{padding: 0;}
    .no-padding-card .el-table__header th,.no-padding-card .el-table__header tr.el-table__row td{text-align: center;padding:5px 0;}
    .el-table__row td .cell{text-align: center;}
    .el-table__row td{padding:5px 0;}
    .main .el-tabs__header{margin:0 0 10px;}
    .fiex-card{width: 200px;position: fixed;top: 26px;padding: 0 0 0 20px;}
    .sortActive{color:#F5B6A7}
    .sortActive:focus{color:#F5B6A7}
    .auth_msg_item{cursor: pointer;}
    .auth_msg_item:hover{color: #bbb;}
    .currentRank_Div{margin-top:20px;width:100%;border-top:1px solid #ebeef5;border-bottom:1px solid #ebeef5;}
    .currentRank_Div .rank_item{display: flex;padding: 5px 0px 5px 7px;}
    .currentRank_Div .rank_item .cell{flex: 1;text-align: center;}
    .el-table .current-user{background: oldlace;}
</style>


<div id="app" style="margin-top:20px;">
    <el-drawer title="达人榜" :visible.sync="rankDrawer" direction="rtl" :show-close="false" stripe>
        <el-table :data="userRankDrawer.list":row-class-name="currentUser" style="width: 100%;margin:10px 5px;text-align: center;">
            <el-table-column prop="rn" label="排名" header-align="center"></el-table-column>
            <el-table-column prop="user_nickname" label="用户" header-align="center"></el-table-column>
            <el-table-column prop="view_count_total" label="阅读量" header-align="center"></el-table-column>
        </el-table>
        <div class="currentRank_Div">
            <div class="rank_item" v-if="currentUserRank && '{$user_id}'!==''">
                <div class="cell">
                    <div>{{currentUserRank.rn}}</div>
                </div>
                <div class="cell">
                    <div>{{currentUserRank.user_nickname}}</div>
                </div>
                <div class="cell">
                    <div>{{currentUserRank.view_count_total}}</div>
                </div>
            </div>
            <div class="rank_item" v-if="!currentUserRank && '{$user_id}'!==''">
                <div class="cell">
                    <div>暂无排名</div>
                </div>
            </div>
            <div class="rank_item" v-if="!currentUserRank && '{$user_id}'===''">
                <div class="cell">
                    <div>请 <a href="{:url('login')}" class="navbar-link color-b" target="_blank">登录</a> 查看排名</div>
                </div>
            </div>
        </div>
        <el-pagination background layout="prev, pager, next" :page-size="userRankDrawer.size" :total="userRankDrawer.total" @current-change="rankToPage" @prev-click="rankToPage" @next-click="rankToPage" style="text-align:center;"></el-pagination>
    </el-drawer>
    <el-container>
        <div class="container" style="margin-bottom:20px;min-height: 750px;padding:0 30px;" id="main">
            <el-container>          
                <el-main>
                    <el-container>
                        <el-main style="margin:0 20px 0 0;">
                            <input type="text" class="form-control" placeholder="请输入文章标题" style="height: 43px;margin-bottom:10px;" v-model="title">

                            <div class="edit-style clearfix">
                                <script id="myEdit" name="content" type="text/plain"></script>
                                <button class="btn btn-light-blue pull-right" style="margin:20px" @click="publish">确认发布</button>
                            </div>
                        </el-main>
                        <el-aside width="300px">

                            <el-card class="aside-item no-padding-card" shadow="hover" style="min-height: 383px;">
                                <div slot="header">
                                    <span>达人榜</span>
                                    <el-link type="primary" :underline="false" style="float:right;" @click="showRankMore">更多</el-link>
                                </div>
                                <el-table
                                    :data="userRank"
                                    style="width: 100%"
                                    stripe
                                    style="text-align: center;"
                                    >
                                    <el-table-column
                                        prop="rn"
                                        label="排名"
                                    ></el-table-column>
                                    <el-table-column
                                        prop="user_nickname"
                                        label="用户"
                                    >
                                    </el-table-column>
                                    <el-table-column
                                        prop="view_count_total"
                                        label="阅读量">
                                    </el-table-column>
                                </el-table>
                            </el-card>

                        </el-aside>
                    </el-container>
                    <!-- 加载编辑器的容器 -->
                    
                    <!-- <el-card class="blue-bgc"> -->
                    <div class="main">
                        <el-tabs>
                            <el-tab-pane label="热门帖子" name="first" >
                                <span slot="label">
                                    <i class="el-icon-sunny"></i>热门帖子
                                </span>
                            </el-tab-pane>

                            <p style="margin-left:5px;">
                                <a href="javascript:" :class="{'sortActive':articleSort=='time'}" @click="sortChange('time')">按时间</a> | 
                                <a href="javascript:" :class="{'sortActive':articleSort=='view'}" @click="sortChange('view')">按热门</a> | 
                                <a href="javascript:" :class="{'sortActive':articleSort==''}" @click="sortChange('')">按关注</a>
                            </p>

                            <div class="search-row">
                                <div class="input-group" style="margin-bottom:10px;">
                                    <input type="text" class="form-control" placeholder="查找主题" style="height: 43px;" v-model="keyword" @keyup.enter="getArticle(1)">
                                    <span class="input-group-btn">
                                        <button class="btn btn-light-blue" type="button" style="line-height: 29px;" @click="getArticle(1)">
                                            <span class="glyphicon glyphicon-search"></span>
                                            搜索
                                        </button>
                                    </span>
                                </div>
                            </div>
                            <div class="main_wrap">
                                <ul class="main_list">
                                    <li class="main-row" v-for="(item,i) in articleList" :key="item.id">
                                        <div class="avatar">
                                            <a href="#">
                                                <img src="__STATIC__/images/avatar.jpg" alt="">
                                            </a>
                                        </div>
                                        <div class="list-content">
                                            <p class="title" style="margin-left:10px;">
                                                <a :href="'/{$Request.module}/{$Request.controller}/articleDet/id/' + item.id">{{item.title}}</a>
                                                <!-- <span class="label label-danger" style="padding-top:0.3em;">精</span> -->
                                            </p>
                                            <div class="auth_msg">
                                                <a href="#" style="color:#000;">{{item.user_nickname}}</a>
                                                <span>{{item.offsetTime}}</span>
                                                <!-- <span>置顶</span> -->
                                                <p class="pull-right">
                                                    <span class="auth_msg_item" @click="giveLike(item.id,i)">
                                                        <span class="glyphicon glyphicon-thumbs-up" style="color:#8c8c8c;"></span>&nbsp;{{item.like_count>999?"999+":item.like_count}}
                                                    </span>
                                                    &nbsp;&nbsp;
                                                    <span>
                                                        <span class="glyphicon glyphicon-eye-open"></span>&nbsp;{{item.view_count>999?"999+":item.view_count}}
                                                    </span>
                                                    &nbsp;&nbsp;
                                                    <span>
                                                        <span class="glyphicon glyphicon-comment"></span>&nbsp;{{item.comment_count>999?"999+":item.comment_count}}
                                                    </span>   
                                                </p>
                                            </div>
                                        </div>
                                    </li>

                                </ul>
                                <div class="pagination" v-if="total">
                                    <el-pagination
                                        background
                                        layout="prev, pager, next"
                                        :page-size="page_size"
                                        :total="total"
                                        @current-change="toPage"
                                        @prev-click="toPage"
                                        @next-click="toPage">
                                    </el-pagination>
                                </div>
                            </div> 
                        </el-tabs>
                    </div>
                </el-main>
            </el-container>
        </div>
    </el-container>

    <el-card class="fiex-card">
        <p><a href="">我的帖子</a></p>
        <p><a href="">我的评论</a></p>
        <p><a href="">我的点赞</a></p>
        <p><a href="">我的关注</a></p>
    </el-card>
</div>

<script>
    var ue = UE.getEditor('myEdit',{
        toolbars:[
            ['bold','fontsize','blockquote','forecolor','justifyleft','justifycenter','justifyright','link','unlink','simpleupload','source']
        ],
        enableAutoSave:false,
        maximumWords:5000,
        allHtmlEnabled: true
    });

    var vue = {
        el:"#app",
        data:{
            title:'',
            name:"yejianfa",
            age:18,
            articleList:[],
            total:0,
            page_size:0,
            keyword:'',
            articleSort: 'time',
            userRankDrawer:{
                list: [],
                page: 1,
                size: 10,
                total: 0
            },
            userRank:[],
            rankDrawer: false,
            currentUserRank: null
        },
        mounted () {
            this.getArticle(1);
            this.getUserScore(9);
        },
        methods: {
            publish(){

                if(this.title){
                    var content = JSON.stringify(/<body[^>]*>([\s\S]*)<\/body>/.exec(ue.getAllHtml())[1]);
                    axios.post("{:url('saveEditor')}",{
                        "content": content,
                        "title":this.title
                        }).then((res)=>{
                        if(res.data == 1001){
                            ue.setContent("");
                            this.$message("发布成功");
                            this.getArticle(1);
                        }else{
                            this.$message("发布失败");
                        }
                    });
                }else{
                    this.$message("请输入标题");
                }

            },
            getArticle(page){
                axios.get("{:url('getArticle')}",{
                    params:{
                        page,
                        keyword:this.keyword,
                        sortType: this.articleSort
                    }
                }).then((res) => {
                    var data = res.data;
                    this.articleList = data['list'];
                    this.total = data['total'];
                    this.page_size = data['page_size'];
                })
            },
            getUserScore(size){
                axios.get("{:url('getUserScore')}",{
                    params:{
                        page: 1,
                        size: size,
                    }
                }).then((res) => {
                    this.userRank = res.data.list;
                });

            },
            getUserScoreDrawer(){
                axios.get("{:url('getUserScore')}",{
                    params:{
                        page: this.userRankDrawer.page,
                        size: this.userRankDrawer.size
                    }
                }).then((res) => {
                    this.userRankDrawer.list = res.data.list;
                    this.userRankDrawer.total = res.data.total;
                });

            },
            getUserScoreById(){
                axios.post("{:url('getUserScoreById')}",{
                    user_id: '{$user_id}'
                }).then((res) => {
                    if(res.data)
                        this.currentUserRank = res.data[0];

                });

            },
            currentUser({row,rowIndex}){
                if(row.user_id == '{$user_id}'){
                    return 'current-user';
                }
            },
            showRankMore(){
                this.rankDrawer=true;
                this.userRankDrawer.page = 1;
                this.getUserScoreDrawer();
                this.getUserScoreById();
            },
            toPage(page){
                this.getArticle(page);
            },
            rankToPage(page){
                this.userRankDrawer.page = page;
                this.getUserScoreDrawer();
            },
            sortChange(type){
                this.articleSort = type;
                this.getArticle(1);

            },
            giveLike(id,i){
                axios.post("{:url('giveLike')}",{article_id:id}).then((res) => {
                    if(res.data == 1001){
                        ++this.articleList[i].like_count;
                    }else if(res.data == 1002){
                        --this.articleList[i].like_count;
                    }else if(res.data == 1004){
                        parent.location.href = "/yslive/index/login";
                    }
                });
            }
        },
        watch:{
            keyword:function(newV,oldV){
                this.getArticle(1);
            }
        }
    };
</script>
